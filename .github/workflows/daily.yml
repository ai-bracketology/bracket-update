name: Daily CBB update

on:
  schedule:
    - cron: "0 10 * * *"  # ~5AM ET (6AM during DST)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests gspread google-auth kenpompy

      - name: Scrape yesterday's games (ET)
        run: |
          YESTERDAY_ET=$(TZ=America/New_York date -d "yesterday" +%F)
          echo "Scraping games for: $YESTERDAY_ET (America/New_York)"
          python scripts/scrape_games.py "$YESTERDAY_ET" -o games.csv

      - name: Fetch KenPom efficiency table
        run: |
          python scripts/fetch_kenpom.py --out kenpom.csv
        env:
          KENPOM_USER: ${{ secrets.KENPOM_USER }}
          KENPOM_PASS: ${{ secrets.KENPOM_PASS }}

      - name: Dump KenPom CSV into KenPom2 tab
        run: |
          python scripts/overwrite_tab_from_csv.py \
            --sheet-id "${{ secrets.SHEET_ID }}" \
            --tab "KenPom2" \
            --csv kenpom.csv
        env:
          GOOGLE_SA_JSON: ${{ secrets.GOOGLE_SA_JSON }}

      - name: Append games.csv to Google Sheet (Games tab)
        run: |
          python scripts/append_games_to_sheet.py \
            --sheet-id "${{ secrets.SHEET_ID }}" \
            --tab "Games" \
            --csv games.csv
            --dedupe-lookback 400
        env:
          GOOGLE_SA_JSON: ${{ secrets.GOOGLE_SA_JSON }}
